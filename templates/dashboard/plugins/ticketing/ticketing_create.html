<!DOCTYPE html>
<html lang="en">
<head>
  {% include 'include/dash-links.html' %}
  <link href="{{ url_for('static', filename='dash/css/Embed.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='dash/css/EmojiPicker.css') }}" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css"/>
  
  <script src="{{ url_for('static', filename='dash/js/EmojiPicker.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>
</head>
<body>
  <!-- ======= Header & Sidebar ======= -->
  {% include 'components/DashNavbar.html' %}
  {% include 'components/Sidebar.html' %}
  
  <!-- ======= Main ======= -->
  <main id="main" class="main">
    <div class="pagetitle plugin">
      <div class="d-flex align-items-center">
        <a href="/dashboard/{{guild.id}}/ticketing"><i class="bi bi-arrow-left pe-2"></i></a>
        <h1 class="em-title" onclick="convertToInput(this)">New ticketing panel</h1>
      </div>

      <div class="buttons">
        <button type="button" id="discard-btn" class="btn btn-secondary">Discard</button>
        <button type="button" id="save-btn" class="btn btn-blurple">Publish</button>
      </div>
    </div>
  
    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>General</h2>
        </div>
        <hr>

        <div class="mb-3">
          <p class="mb-1">Publish Channel <r style="color: red;">*</r></p>
          <div class="publish-chan-select-wrapper single">
            <div class="select">
              <div class="select-selected">Select an option</div>
              <div class="select-options">
                {% for channel in guild_models(guild).channels.text %}
                <div class="option" data-type="channel" data-id="{{channel.id}}" data-name="{{channel.name}}" data-can-send="{{channel.can_send}}">{{channel.name}}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <p class="mb-1">Ticket Manager Roles</p>
          <div class="manage-roles-select-wrapper single">
            <div class="select">
              <div class="select-selected">Select an option</div>
              <div class="select-options">
              {% for role in guild_models(guild).roles %}
              <div class="option" data-type="role" data-id="{{role.id}}" data-name="{{role.name}}" data-disabled="{{role.disabled}}" style="--color: {{role.color}}">{{role.name}}</div>
              {% endfor %}
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Pannel message</h2>
        </div>
        <hr>
        
        <div class="d-flex gap-2 mb-3">
          <div class="con color-picker full">
            <div class="clr-field" style="color: #5865f2;">
              <button aria-labelledby="clr-open-label"></button>
              <input type="text" class="pm-embed-color coloris" name="pm-embed-color">
            </div>
          </div>
          
          <div class="pm-embed embed" style="border-left-color: #5865f2;">
            <div class="e-bdFBtt">
              <div class="title embedMargin-2PsaQ4">
                <input type="text" name="pm-embed-title" id="pm-embed-title" placeholder="Title">
              </div>
              <div class="desc embedMargin-2PsaQ4">
                <textarea type="text" name="pm-embed-desc" id="pm-embed-desc" placeholder="Description" oninput="auto_grow(this)"></textarea>
                <script>
                  auto_grow(document.querySelector('#pm-embed-desc'));
                  function auto_grow(element) {
                    element.style.height = "5px";
                    element.style.height = (element.scrollHeight + 2) + "px";
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Pannel button</h2>
        </div>
        <hr>
        
        <button id="btn-preview" class="position-relative btn btn-secondary" style="max-width: 250px;overflow: hidden;text-overflow: ellipsis;">
          <span id="emoji">ðŸ“©</span>
          <span id="label">Open Ticket</span>

          <div class="position-absolute top-50 start-50 translate-middle gap-1  edit">
            <i class="bi bi-pencil-fill"></i>
            Edit
          </div>
        </button>

        <div id="btn-edit" class="mt-2" style="display: none;">
          <div class="d-flex" style="flex-wrap: wrap;border-left: 2px solid gray;padding-left: 16px;column-gap: 1rem;row-gap: 0.5rem;">
            <div>
              <p class="mb-0">Emoji</p>
              <div class="btn-wrapper">
                <div id="embed-emoji" style="cursor: context-menu;" trigger>
                  +
                </div>
              </div>
            </div>

            <div>
              <p class="mb-0">label</p>
              <input type="text" id="btn-label" class="text-input" placeholder="Title" value="Open Ticket">
            </div>

            <div>
              <p class="mb-0">Colors</p>
              <div class="d-flex gap-1 btn-wrapper">
                <div class="radio-wrapper">
                  <input type="radio" id="btn-color-picker-gray" name="btn-color" data-color="gray">
                </div>
                <div class="radio-wrapper">
                  <input type="radio" id="btn-color-picker-b" name="btn-color" data-color="blurple">
                </div>
                <div class="radio-wrapper">
                  <input type="radio" id="btn-color-picker-red" name="btn-color" data-color="red">
                </div>
                <div class="radio-wrapper">
                  <input type="radio" id="btn-color-picker-green" name="btn-color" data-color="green">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <h5 class="mb-0">Category options</h5>
        
          <div class="mt-2">
            <p class="mb-1">Category where tickets will be created <r style="color: red;">*</r></p>
            <div class="create-tk-cat-select-wrapper single">
              <div class="select">
                <div class="select-selected">Select an option</div>
                <div class="select-options">
                {% for channel in guild_models(guild).channels.categories %}
                  <div class="option" data-type="category" data-id="{{channel.id}}" data-name="{{channel.name}}">{{channel.name}}</div>
                {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <p class="mb-1">Category where claimed tickets will be moved <r style="color: red;">*</r></p>
            <div class="claimed-tk-cat-select-wrapper single">
              <div class="select">
                <div class="select-selected">Select an option</div>
                <div class="select-options">
                {% for channel in guild_models(guild).channels.categories %}
                  <div class="option" data-type="category" data-id="{{channel.id}}" data-name="{{channel.name}}">{{channel.name}}</div>
                {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <p class="mb-1">Category where closed tickets will be moved <r style="color: red;">*</r></p>
            <div class="closed-tk-cat-select-wrapper single">
              <div class="select">
                <div class="select-selected">Select an option</div>
                <div class="select-options">
                {% for channel in guild_models(guild).channels.categories %}
                  <div class="option" data-type="category" data-id="{{channel.id}}" data-name="{{channel.name}}">{{channel.name}}</div>
                {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Ticket introduction message</h2>
        </div>
        <hr>
        
        <div class="d-flex gap-2 mb-3">
          <div class="con color-picker full">
            <div class="clr-field" style="color: #5865f2;">
              <button aria-labelledby="clr-open-label"></button>
              <input type="text" class="im-embed-color coloris" name="im-embed-color">
            </div>
          </div>
          
          <div class="im-embed embed" style="border-left-color: #5865f2;">
            <div class="e-bdFBtt">
              <div class="title embedMargin-2PsaQ4">
                <input type="text" name="im-embed-title" id="im-embed-title" placeholder="Title">
              </div>
              <div class="desc embedMargin-2PsaQ4">
                <textarea type="text" name="im-embed-desc" id="im-embed-desc" placeholder="Description" oninput="auto_grow(this)"></textarea>
                <script>
                  auto_grow(document.querySelector('#im-embed-desc'));
                  function auto_grow(element) {
                    element.style.height = "5px";
                    element.style.height = (element.scrollHeight + 2) + "px";
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Ticket transcript</h2>
        </div>
        <hr>

        <div class="mb-3">
          <p class="mb-1">Transcript Channel <r style="color: red;">*</r></p>
          <div class="transcript-chan-select-wrapper single">
            <div class="select">
              <div class="select-selected">Select an option</div>
              <div class="select-options">
              {% for channel in guild_models(guild).channels.text %}
                <div class="option" data-type="channel" data-id="{{channel.id}}" data-name="{{channel.name}}" data-can-send="{{channel.can_send}}">{{channel.name}}</div>
              {% endfor %}
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="transcript-dm" name="transcript-dm">
              <label class="form-check-label" for="transcript-dm">
                Send the transcript link in private to the member that created the ticket
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    new Select('.publish-chan-select-wrapper.single', {
      placeholder: "Select a channel",
      type: 'channel',
      multiple: false,
      maxItems: 1,
      options: []
    })

    new Select('.manage-roles-select-wrapper.single', {
      placeholder: "Select a role",
      type: 'role',
      multiple: true,
      maxItems: 0,
      removeBtn: true,
      options: []
    });

    // Category select
    new Select('.create-tk-cat-select-wrapper.single', {
      placeholder: "Select a category",
      type: 'category',
      multiple: false,
      maxItems: 1,
      options: []
    });
    new Select('.claimed-tk-cat-select-wrapper.single', {
      placeholder: "Select a category",
      type: 'category',
      multiple: false,
      maxItems: 1,
      options: []
    });
    new Select('.closed-tk-cat-select-wrapper.single', {
      placeholder: "Select a category",
      type: 'category',
      multiple: false,
      maxItems: 1,
      options: []
    });

    // transcription select
    new Select('.transcript-chan-select-wrapper.single', {
      placeholder: "Select a channel",
      type: 'channel',
      multiple: false,
      maxItems: 1,
      options: []
    });

    // Color picker
    Coloris({
      el: '.pm-embed-color',
      theme: 'large',
      themeMode: 'dark',
      format: 'hex',
      formatToggle: false,
      closeButton: true,
      defaultColor: '#5865f2',
      swatches: [ '#5865f2', '#57F287', '#FEE75C', '#EB459E', '#ED4245', '#FFFFFF', '#000000' ]
    });
    Coloris({
      el: '.im-embed-color',
      theme: 'large',
      themeMode: 'dark',
      format: 'hex',
      formatToggle: false,
      closeButton: true,
      defaultColor: '#5865f2',
      swatches: [ '#5865f2', '#57F287', '#FEE75C', '#EB459E', '#ED4245', '#FFFFFF', '#000000' ]
    });

    new EmojiPicker({
      trigger: '#embed-emoji',
      position: ['bottom', 'right'],
      emit(emoji) {
        console.log(emoji)
        emojiButton(emoji);
      }
    });

    let ticket_data = {
      channel_id: null,
      manager_roles: [],
      category_open: null,
      category_claimed: null,
      category_closed: null,
      transcript_channel: null,
      transcript_dm: false
    }

    document.querySelector('#discard-btn').addEventListener('click', (e) => {
      if (Object.keys(ticket_data).length > 0) {
        var res = confirm("Are you sure you want to discard changes?")
        if (res) {
          window.location.href = '/dashboard/{{guild.id}}/ticketing'
        }
      } else {
        window.location.href = '/dashboard/{{guild.id}}/ticketing'
      }
    })

    document.querySelector('#save-btn').addEventListener('click', (e) => {
      // console.log(ticket_data)
      fetch("creation", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(ticket_data),
      })
        .then(res => res.json())
        .then(data => {
          if (data.status == 'success') {
            window.location.href = '/dashboard/{{guild.id}}/ticketing'
          }
        })
    })

    function convertToInput(element) {
      // Create an input element
      const input = document.createElement("input");
      input.className = "em-title-input";
      input.type = "text";
      input.value = element.innerText; // Set input value to current text

      // Add event listener to handle when the user clicks outside of the input
      input.addEventListener("blur", () => {
        revertToText(element, input);
      });

      // Replace the <h1> element with the input
      element.replaceWith(input);
      input.focus();
    }

    function revertToText(element, input) {
      const h1 = document.createElement("h1");
      h1.className = element.className;
      h1.onclick = () => convertToInput(h1);
      h1.innerText = input.value || "New ticketing panel"; // Set text to input value or default text
      input.replaceWith(h1);

      ticket_data['pannel_name'] = input.value;
    }

    document.addEventListener('DOMContentLoaded', () => {
      ticket_data['pannel_name'] = document.querySelector('.em-title').innerText;
    })

    /* General */
    const publishChannelSelectWrapper = document.querySelector('.publish-chan-select-wrapper.single');
    publishChannelSelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;
      var option = selectedOptions[0] ? selectedOptions[0] : ''

      ticket_data['channel_id'] = option;
    })

    /* Ticket Manager Roles */
    const managerRoleSelectWrapper = document.querySelector('.manage-roles-select-wrapper.single');
    managerRoleSelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;

      ticket_data['manager_roles'] = selectedOptions;
    })

    /* Panel Message */
    const PmEmbed = document.querySelector('.pm-embed');
    const PmEmbedColor = document.querySelector('.pm-embed-color');
    const PmEmbedTitle = PmEmbed.querySelector('#pm-embed-title');
    const PmEmbedDesc = PmEmbed.querySelector('#pm-embed-desc');

    document.addEventListener('DOMContentLoaded', () => {
      ticket_data['pannel_message.embed.color'] = parseInt('#5865f2'.replace("#", ""), 16);
    })
    PmEmbedColor.addEventListener('change', (e) => {
      var value = e.target.value;

      PmEmbed.style.borderColor = value;

      ticket_data['pannel_message.embed.color'] = parseInt(value.replace("#", ""), 16);
    })

    PmEmbedTitle.addEventListener('input', (e) => {
      var value = e.target.value;      
      ticket_data['pannel_message.embed.title'] = value;
    })

    PmEmbedDesc.addEventListener('input', (e) => {
      var value = e.target.value;      
      ticket_data['pannel_message.embed.description'] = value;
    })

    /* Panel Button */
    const btnPreview = document.querySelector('#btn-preview');
    const btnEdit = document.querySelector('#btn-edit');
    const emojiBtn = document.querySelector('#embed-emoji');

    document.addEventListener('DOMContentLoaded', () => {
      ticket_data['pannel_button.emoji'] = btnPreview.querySelector('#emoji').innerHTML
      ticket_data['pannel_button.label'] = btnPreview.querySelector('#label').innerHTML
      ticket_data['pannel_button.style'] = 'gray'
    })

    function emojiButton(emoji) {
      btnPreview.querySelector('#emoji').innerHTML = emoji.icon;
      emojiBtn.innerHTML = '';
      emojiBtn.insertAdjacentHTML('afterbegin', emoji.icon);

      if (!btnEdit.querySelector('.btn-wrapper i')) {
        btnEdit.querySelector('.btn-wrapper').insertAdjacentHTML('beforeend', '<i class="bi bi-trash-fill"></i>');
      }
      
      ticket_data['pannel_button.emoji'] = emoji.icon;
    }

    btnPreview.addEventListener('click', () => {
      if (btnEdit.style.display == 'block') {
        btnEdit.style.display = 'none';
      } else {
        btnEdit.style.display = 'block';
      }
    })

    const deleteBtnEmoji = btnEdit.querySelector('.btn-wrapper i');
    if (deleteBtnEmoji) {
      deleteBtnEmoji.addEventListener('click', () => {
        emojiBtn.innerHTML = '+';
        deleteBtnEmoji.remove();

        btnPreview.querySelector('#emoji').innerHTML = '';
        
        ticket_data['pannel_button.emoji'] = '';
      })
    }

    // panel button label
    const btnLabel = btnEdit.querySelector('.text-input');
    btnLabel.addEventListener('input', (e) => {
      var value = e.target.value;

      btnPreview.querySelector('#label').innerHTML = value;

      ticket_data['pannel_button.label'] = value;
    })

    // panel button color
    var data = {
      "gray": "secondary",
      "blurple": "blurple",
      "red": "danger",
      "green": "success"
    }

    const btnColor = btnEdit.querySelectorAll('input[name="btn-color"]');
    btnColor.forEach(color => {
      color.addEventListener('change', (e) => {
        var value = e.target.dataset.color;

        btnPreview.classList.forEach(cls => {
          if (cls.startsWith('btn-')) {
            btnPreview.classList.remove(cls);
          }
        })

        btnPreview.classList.add(`btn-${data[value]}`);
        
        ticket_data['pannel_button.style'] = value;
      })
    })

    /* Panel Button Category Options */
    // Ticket Open Category
    const openCategorySelectWrapper = document.querySelector('.create-tk-cat-select-wrapper.single');
    openCategorySelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;
      var option = selectedOptions[0] ? selectedOptions[0] : ''

      ticket_data['category_open'] = option;
    })
    // Ticket Claimed Category
    const claimedCategorySelectWrapper = document.querySelector('.claimed-tk-cat-select-wrapper.single');
    claimedCategorySelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;
      var option = selectedOptions[0] ? selectedOptions[0] : ''

      ticket_data['category_claimed'] = option;
    })
    // Ticket Close Category
    const closeCategorySelectWrapper = document.querySelector('.closed-tk-cat-select-wrapper.single');
    closeCategorySelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;
      var option = selectedOptions[0] ? selectedOptions[0] : ''

      ticket_data['category_closed'] = option;
    })

    /* Intro Ticket Message */
    const ImEmbed = document.querySelector('.im-embed');
    const ImEmbedColor = document.querySelector('.im-embed-color');
    const ImEmbedTitle = ImEmbed.querySelector('#im-embed-title');
    const ImEmbedDesc = ImEmbed.querySelector('#im-embed-desc');

    document.addEventListener('DOMContentLoaded', () => {
      ticket_data['intro_message.embed.color'] = parseInt('#5865f2'.replace("#", ""), 16);
    })
    ImEmbedColor.addEventListener('change', (e) => {
      var value = e.target.value;

      ImEmbed.style.borderColor = value;

      ticket_data['intro_message.embed.color'] = parseInt(value.replace("#", ""), 16);
    })

    ImEmbedTitle.addEventListener('input', (e) => {
      var value = e.target.value;      
      ticket_data['intro_message.embed.title'] = value;
    })

    ImEmbedDesc.addEventListener('input', (e) => {
      var value = e.target.value;      
      ticket_data['intro_message.embed.description'] = value;
    })

    /* Ticket Transcript */
    // Channel
    const transcriptChanSelectWrapper = document.querySelector('.transcript-chan-select-wrapper.single');
    transcriptChanSelectWrapper.addEventListener('select:update', function (event) {
      var selectedOptions = event.detail.selectedOptions;
      var option = selectedOptions[0] ? selectedOptions[0] : ''

      ticket_data['transcript_channel'] = option;
    })

    // DM
    const transcriptDm = document.querySelector('#transcript-dm');
    transcriptDm.addEventListener('change', (e) => {
      var val = e.target.checked
      
      ticket_data['transcript_dm'] = val;
    })
  </script>

  <style>
    .em-title {
      max-width: 40vw;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      
      padding: 3px 6px;
      font-size: 23px!important;
    }

    .em-title:hover {
      cursor: pointer;
      background: #3a9eea;
      border-radius: 8px;
    }

    .em-title-input {
      background: #3a9eea;
      color: #fff;
      padding-top: -0.5px;
      padding-bottom: 0;
      padding-left: 6px;
      padding-right: 6px;
      font-size: 23px;
      font-weight: 700;
      max-width: 40vw;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      border: none;
      border-radius: 8px;
    }
    .em-title-input:focus-visible {
      outline: none;
    }
    
    @media (max-width: 768px) {
      .em-title {
        max-width: 90vw;
      }
    }

    .fs-7 {
      font-size: .875rem; /* 14px */
    }

    .btn-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;

      height: 43px;
      padding: 6px 8px;
      background: black;
      border-radius: 8px;
    }

    #btn-preview .edit {
      display: none;
    }
    #btn-preview:hover .edit {
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bs-btn-bg);
      width: 100%;
      height: 100%;
      border-radius: var(--bs-btn-border-radius);
    }

    .radio-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4px;
      border-radius: 4px;
    }
    .radio-wrapper:hover {
      background: rgb(49 52 66 / 0.7);
    }

    input[type="radio"][data-color="gray"] {
      --color: #4E5058;
    }
    input[type="radio"][data-color="blurple"] {
      --color: #5865f2;
    }
    input[type="radio"][data-color="red"] {
      --color: #ED4245;
    }
    input[type="radio"][data-color="green"] {
      --color: #57F287;
    }

    input[type="radio"] {
      appearance: none;
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--color);
      outline: 2px solid transparent;
      border-radius: 50%;
    }

    input[type="radio"]:checked {
      outline-color: var(--color);
      outline-offset: 1px;
    }
  </style>

</body>
</html>