<!DOCTYPE html>
<html lang="en">
<head>
  {% include 'include/dash-links.html' %}
  <link href="{{ url_for('static', filename='dash/css/Embed.css') }}" rel="stylesheet">

  <!-- Popperjs -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <!-- Tempus Dominus JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js" crossorigin="anonymous"></script>
  <!-- Tempus Dominus Styles -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css" crossorigin="anonymous">

  <!-- {# 
    config = get_dash_config(guild.id).get('giveaway')
    data = get_server_config(guild.id).get('giveaways')
  #} -->
</head>
<body>
  <!-- ======= Header & Sidebar ======= -->
  {% include 'components/DashNavbar.html' %}
  {% include 'components/Sidebar.html' %}

  {% set plugin = get_plugin(guild, 'giveaway') %}
  
  <!-- ======= Main ======= -->
  <main id="main" class="main">
    <div class="pagetitle plugin">
      <div>
        <h1 class="em-title">Create new giveaway</h1>
      </div>

      <div class="buttons">
        <button type="button" id="delete" class="btn btn-danger"><i class="bi bi-trash  mr-1"></i> Delete</button>
        <button type="button" id="discard-btn" class="btn btn-secondary">Discard</button>
        <button type="button" id="save-btn" class="btn btn-blurple" disabled>Save</button>
      </div>
    </div>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Manage</h2>
        </div>
        <hr>
        
        <div class="mb-2 em-name">
          <label for="gwayname-name">Giveaway name <req style="color: red;">*</req></label><br>
          <input type="text" id="gwayname-name" class="text-input" value="{{data.name}}" />
        </div>
        
        <div class="mb-0">
          <p class="mb-1">Channel <req style="color: red;">*</req></p>
          <div class="gway-chan-select-wrapper single">
            <div class="select">
              <div class="select-selected">Select an option</div>
              <div class="select-options">
                {% for channel in guild_models(guild).channels.text %}
                <div class="option" data-type="channel" data-id="{{channel.id}}" data-name="{{channel.name}}" data-can-send="{{channel.can_send}}">{{channel.name}}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Settings</h2>
        </div>
        <hr>

        <div class="mt-0">
          <label for="gway-prize">Prize <req style="color: red;">*</req></label><br>
          <p class="mb-1 fs-7 text-muted">What are the members winning?</p>
          <input type="text" id="gway-prize" class="text-input" value="{{data.prize}}" />
        </div>

        <div class="mt-2">
          <label for="gway-winners">Number of Winners <req style="color: red;">*</req></label><br>
          <p class="mb-1 fs-7 text-muted">How many members will win?</p>
          <input type="text" id="gway-winners" class="text-input" value="{{data.winners}}" />
        </div>

        <div class="mt-2">
          <p class="mb-1 fs-7">End time <req style="color: red;">*</req></p>
          
          <div class="container m-0" style="max-width: var(--input-width);">
            <div class="row">
              <div class="form-group p-0">
                <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                  <input type="text" name="datetime-picker1" class="form-control datetimepicker-input text-input" data-target="#datetimepicker1" />
                  <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                    <div class="input-group-text"><i class="bi bi-calendar"></i></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <p class="mb-1 fs-6">Additional settings</p>
          <div class="form-switch ps-0 user-select-none ">
            <input class="form-check-input ms-0 " type="checkbox" id="gway-givexp" {% if data.givexp.enabled %}checked{% endif %} />
            <label class="form-check-label" for="gway-givexp">Give xp to winners</label>

            <div class="gway-givexp-amount d-none">
              <label for="gway-givexp-amount">Amount of XP</label><br>
              <input type="text" id="gway-givexp-amount" class="text-input" value="{{data.givexp.amount}}">
            </div>
          </div>
          <div class="form-switch ps-0 user-select-none ">
            <input class="form-check-input ms-0 " type="checkbox" id="gway-givecoins" {% if data.givecoins.enabled %}checked{% endif %} />
            <label class="form-check-label" for="gway-givecoins">Give coins to winners</label>

            <div class="gway-givecoins-amount d-none">
              <label for="gway-givecoins-amount">Amount of coins</label><br>
              <input type="text" id="gway-givecoins-amount" class="text-input" value="{{data.givecoins.amount}}">
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="feature_card">
        <div class="title">
          <h2>Message</h2>
        </div>
        <hr>
        <div class="embed">
          <div class="e-bdFBtt">
            <div class="title embedMargin-2PsaQ4">
              <input type="text" id="gway_embed_title" class="input" placeholder="Title" value="ðŸŽ‰ [prize] ðŸŽ‰" disabled>
            </div>
            <div class="desc embedMargin-2PsaQ4">
              <textarea type="text" id="gway_embed_desc" class="input" placeholder="Description">{{data.embed_desc}}</textarea>
            </div>

            <div class="fields">
              <div class="field">
                <div class="name">End</div>
                <div class="value">date</div>
              </div>
              <div class="field">
                <div class="name">Hosted by</div>
                <div class="value">user</div>
              </div>
              <div class="field">
                <div class="name">Winners</div>
                <div class="value">0</div>
              </div>
              <div class="field">
                <div class="name">Participants</div>
                <div class="value">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    new Select('.gway-chan-select-wrapper.single', {
      placeholder: "Select a channel",
      type: 'channel',
      multiple: false,
      maxItems: 1,
      options: ['{{data["channel"]["id"]}}']
    })

    const DateTimePicker = new tempusDominus.TempusDominus(document.getElementById('datetimepicker1'), {
      display: {
        icons: {
          type: 'icons', time: "bi bi-watch", date: "bi bi-calendar", up: "bi bi-arrow-up", down: "bi bi-arrow-down", previous: 'bi bi-chevron-left', next: 'bi bi-chevron-right', today: 'bi bi-calendar-check-o', clear: 'bi bi-trash', close: 'bi bi-times'
        },
      }
    });

    const initial_values = {
      name: '{{data["name"]}}',
      channel_id: '{{data["channel"]["id"]}}',
      prize: '{{data["prize"]}}',
      winners: '{{data["winners"]}}',
      'time.epoch': '{{data["time"]["epoch"]}}',
      'embed.desc': '{{data["embed_desc"]}}'
    }
    
    var required_fields = ['name', 'channel_id', 'prize', 'winners', 'time.time', 'embed.desc'];
    const save_data = new Proxy({ ...initial_values }, {
      set(target, key, value) {
        target[key] = value;
        checkIfDataUpdated();
        return true;
      }
    });

    function checkIfDataUpdated() {
      console.log(save_data);

      const isDataChanged = required_fields.some(field => save_data[field] !== initial_values[field]);
      document.querySelector('#save-btn').disabled = !isDataChanged;
    }


    document.querySelector('#discard-btn').addEventListener('click', (e) => {
      if (required_fields.some(field => save_data[field] !== initial_values[field])) {
        var res = confirm("Are you sure you want to discard changes?")
        if (res) {
          window.location.href = '/dashboard/{{guild.id}}/giveaways'
        }
      } else {
        window.location.href = '/dashboard/{{guild.id}}/giveaways'
      }
    })

    document.querySelector('#save-btn').addEventListener('click', (e) => {
      fetch("edition", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ ...save_data }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.status == 'success') {
            window.location.href = '/dashboard/{{guild.id}}/giveaways'
          }
        })
    })

    // Name
    const gwayNameInput = document.querySelector('#gwayname-name');
    gwayNameInput.addEventListener('input', (e) => {
      save_data['name'] = e.target.value
    })

    // Channel id
    const gwayChanSelectWrapper = document.querySelector('.gway-chan-select-wrapper.single');
    gwayChanSelectWrapper.addEventListener('select:update', (e) => {
      const selectedOptions = event.detail.selectedOptions;
      const option = selectedOptions[0] ? selectedOptions[0] : null

      save_data['channel_id'] = option
    })

    // Prize
    const gwayPrizeInput = document.querySelector('#gway-prize');
    gwayPrizeInput.addEventListener('input', (e) => {
      save_data['prize'] = e.target.value
    })

    // Winners
    const gwayWinnersInput = document.querySelector('#gway-winners');
    gwayWinnersInput.addEventListener('input', (e) => {
      save_data['winners'] = e.target.value
    })

    // Time
    const gwayDateInput = document.querySelector('#datetimepicker1').querySelector('input');
    document.addEventListener('DOMContentLoaded', (e) => {
      var datetime = new Intl.DateTimeFormat('en-US', { 
        day: '2-digit', month: '2-digit', year: '2-digit', 
        hour: '2-digit', minute: '2-digit', hour12: false 
      }).format(new Date('{{data["time"]["epoch"]}}' * 1000))

      gwayDateInput.value = datetime
    })
    gwayDateInput.addEventListener('change', (e) => {
      // console.log(DateTimePicker.viewDate)
      function toTimestamp(dateString) {
        const date = new Date(dateString);
        return date.getTime() / 1000; // Convert from ms to seconds
      }

      function formatDateTime(date) {
        return new Intl.DateTimeFormat('en-US', { 
          day: '2-digit', month: '2-digit', year: '2-digit', 
          hour: '2-digit', minute: '2-digit', hour12: false 
        }).format(new Date(date)).replace(/\//g, '.').replace(',', '');
      }

      save_data['time.epoch'] = toTimestamp(e.target.value)
      save_data['time.timestamp'] = formatDateTime(e.target.value)
    })

    // GiveEXP
    const giveExpInput = document.querySelector('#gway-givexp');
    const giveExpAmount = document.querySelector('.gway-givexp-amount');
    
    document.addEventListener('DOMContentLoaded', (e) => {
      giveExpAmount.classList.toggle('d-none', !giveExpInput.checked)
      // save_data['giveexp.enabled'] = giveExpInput.checked
    })

    giveExpInput.addEventListener('change', (e) => {
      giveExpAmount.classList.toggle('d-none')
      // save_data['giveexp.enabled'] = e.target.checked
    })

    giveExpAmount.addEventListener('input', (e) => {
      save_data['giveexp.amount'] = e.target.value
    })

    // GiveCoins
    const giveCoinsInput = document.querySelector('#gway-givecoins');
    const giveCoinsAmount = document.querySelector('.gway-givecoins-amount');
    
    document.addEventListener('DOMContentLoaded', (e) => {
      giveCoinsAmount.classList.toggle('d-none', !giveCoinsInput.checked)
      // save_data['givecoins.enabled'] = giveCoinsInput.checked
    })

    giveCoinsInput.addEventListener('input', (e) => {
      save_data['givecoins.enabled'] = e.target.value
    })

    giveCoinsAmount.addEventListener('input', (e) => {
      save_data['givecoins.amount'] = e.target.value
    })

    /* Embeds */
    const embedDesc = document.querySelector('#gway_embed_desc');
    document.addEventListener('DOMContentLoaded', (e) => {
      // save_data['embed.desc'] = embedDesc.value
    })
    embedDesc.addEventListener('click', (e) => {
      save_data['embed.desc'] = e.target.value
    })
  </script>

  <style>
    .em-title {
      max-width: 40vw;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      
      padding: 3px 6px;
      font-size: 23px!important;
    }

    @media (max-width: 768px) {
      .em-title {
        max-width: 90vw;
      }
    }

    .dropdown-menu {
      --bs-dropdown-color: var(--bs-body-color);
      --bs-dropdown-bg: var(--bs-body-color);
    }

    .input-group-text {
      --bs-border-color: var(--bs-body-color);
      height: 100%;
      background-color: var(--color-secondary-4);
      color: var(--text-color);
    }

    .bootstrap-datetimepicker-widget table th {
      background: var(--color-secondary-3);
      color: var(--text-color);
    }
    .bootstrap-datetimepicker-widget table thead tr:first-child th:hover {
      background: var(--color-secondary-1);
    }
    .bootstrap-datetimepicker-widget table th:hover {
      background: var(--color-secondary-1);
    }

    .bootstrap-datetimepicker-widget table td.day {
      background: var(--color-secondary-3);
      color: var(--text-color);
    }
    .bootstrap-datetimepicker-widget table td.day:hover {
      background: var(--color-secondary-1);
    }

    .bootstrap-datetimepicker-widget table td.active {
      background: #5865f2;
    }

    .bootstrap-datetimepicker-widget table td span {
      background: var(--color-secondary-3);
      color: var(--text-color);
    }
    .bootstrap-datetimepicker-widget table td span:hover {
      background: var(--color-secondary-1);
    }
  </style>
  
</body>
</html>